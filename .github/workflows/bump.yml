name: Deploy API Documentation to Bump.sh

on:
  push:
    branches: [main]
    paths:
      - '**/*.yaml'
      - '**/*.yml'

jobs:
  deploy-to-bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fix YAML references and create symlinks
        run: |
          echo "Creating symbolic links for missing files..."

          # Create parent directories if they don't exist
          mkdir -p components

          # Create symlinks to handle incorrect paths
          ln -sf "$(pwd)/components/schemas/errors.yaml" "$(pwd)/components/errors.yaml"
          ln -sf "$(pwd)/components/schemas/cards.yaml" "$(pwd)/components/cards.yaml"
          ln -sf "$(pwd)/components/schemas/receipts.yaml" "$(pwd)/components/receipts.yaml"
          ln -sf "$(pwd)/components/schemas/transactions.yaml" "$(pwd)/components/transactions.yaml"

          echo "Verifying symlinks..."
          ls -la components/

          # Check if the symlinks actually work
          if [ -f components/errors.yaml ]; then
            echo "components/errors.yaml is accessible"
            head -n 5 components/errors.yaml
          else
            echo "components/errors.yaml is not accessible"
          fi

          if [ -f components/transactions.yaml ]; then
            echo "components/transactions.yaml is accessible"
            head -n 5 components/transactions.yaml
          else
            echo "components/transactions.yaml is not accessible"
          fi

      - name: Deploy API documentation
        uses: bump-sh/github-action@v1
        with:
          doc: omni-v2
          token: ${{ secrets.BUMP_TOKEN }}
          file: openapi.yaml
